# 実装タスク: 社員管理機能（追加・編集・削除）

## 実装方針

本タスクリストは、Gap分析で推奨されたハイブリッドアプローチのフェーズ1（MVP）に基づいています。Server Actionsの初回実装として、基本的なCRUD操作を段階的に実装し、技術的リスクを軽減します。

**フェーズ1の目標**:
- Server Actions実装パターンの確立
- 管理者権限チェックの徹底
- 基本的な新規追加・編集・削除機能の実装
- データベースCRUD操作とバリデーション

**実装順序の原則**:
1. 下位レイヤーから上位レイヤーへ（データレイヤー → Server Actions → UIコンポーネント）
2. TDD方式（テストファースト、実装、リファクタリング）
3. 各タスクで統合テストまで完了させる

---

## タスク一覧

### 1. 型定義とバリデーション基盤

- [x] 1.1 (P) 社員データ型定義を実装
  - `CreateEmployeeInput`型: 新規追加時の入力データ型（社員番号、氏名、メール、入社日、携帯電話）
  - `UpdateEmployeeInput`型: 更新時の入力データ型（社員番号以外の更新可能フィールド）
  - `ActionResult<T>`型: Server Actionsの戻り値型（success, data, errors, fieldErrors）
  - `ValidationError`型: バリデーションエラー情報
  - _Requirements: 2.2, 3.2, 6.1, 6.2, 6.3, 6.4, 6.5_

- [x] 1.2 (P) バリデーション関数を実装（TDD）
  - メールアドレス形式検証（正規表現）
  - 入社日の有効性検証（未来日チェック、日付形式チェック）
  - 必須フィールド検証（社員番号、氏名（漢字・カナ）、メール、入社日）
  - 文字数制限検証（社員番号20文字、氏名100文字、メール255文字、携帯電話20文字）
  - `validateEmployeeData()`関数でまとめて検証、`ValidationResult`型を返却
  - テストケース: 有効なデータ、各フィールドの空値、不正なメール形式、未来の入社日、文字数超過
  - _Requirements: 2.3, 2.4, 2.5, 6.1, 6.2, 6.3, 6.4, 6.5_

---

### 2. データレイヤー実装（Service Layer）

- [x] 2.1 (P) 新規社員作成機能を実装（TDD）
  - 社員レコードをemployeesテーブルに挿入
  - `returning()`句で挿入データを取得
  - 非トランザクション実装（フェーズ1は単一テーブル操作）
  - 初期値設定: `photoS3Key`はnull、`organizations`は空配列
  - UNIQUE制約違反のハンドリング（社員番号、メールアドレス）
  - テストケース: 正常作成、重複社員番号、重複メールアドレス、存在しないデータ
  - _Requirements: 2.6, 6.1, 6.2, 6.6_

- [x] 2.2 (P) 社員情報更新機能を実装（TDD）
  - 指定した社員IDのレコードを更新
  - 社員番号は更新対象外（読み取り専用）
  - `returning()`句で更新データを取得
  - 非トランザクション実装
  - UNIQUE制約違反のハンドリング（メールアドレス）
  - 存在しない社員IDのエラーハンドリング
  - テストケース: 正常更新、重複メールアドレス、存在しない社員ID
  - _Requirements: 3.5, 3.7, 6.2_

- [x] 2.3 (P) 社員削除機能を実装（TDD）
  - 指定した社員IDのレコードを削除（物理削除）
  - CASCADE DELETE設定により`employee_organizations`も自動削除
  - 非トランザクション実装
  - 存在しない社員IDのエラーハンドリング
  - テストケース: 正常削除、存在しない社員ID、CASCADE DELETEの動作確認
  - _Requirements: 4.5, 4.6_

---

### 3. Server Actions実装

- [ ] 3.1 共通権限チェック関数を実装
  - `checkAdminPermission()`関数: `getUser()`でユーザー取得、`getProfileByUserId()`でrole取得
  - `role`が`admin`でない場合は`Error("Forbidden")`をスロー
  - テストケース: 管理者権限あり、一般ユーザー、未認証ユーザー
  - _Requirements: 1.1, 1.6, 2.1_

- [ ] 3.2 新規社員追加Server Actionを実装
  - `createEmployeeAction(formData)`: FormDataから入力データ抽出
  - 権限チェック実行（`checkAdminPermission()`）
  - バリデーション実行（`validateEmployeeData()`）
  - `createEmployee()`呼び出し
  - UNIQUE制約違反のエラーハンドリング（PostgreSQLエラーコード23505検知）
  - キャッシュ再検証（`revalidatePath("/employees")`, `revalidatePath("/employees/[id]")`）
  - 成功時に社員詳細画面へリダイレクト（`redirect("/employees/[id]")`）
  - テストケース: 正常作成とリダイレクト、権限エラー、バリデーションエラー、UNIQUE制約違反
  - _Requirements: 1.2, 1.5, 2.1, 2.3, 2.4, 2.5, 2.6, 2.7, 2.8, 6.1, 6.2, 8.3_

- [ ] 3.3 社員情報更新Server Actionを実装
  - `updateEmployeeAction(employeeId, formData)`: FormDataから更新データ抽出
  - 権限チェック実行
  - バリデーション実行
  - `updateEmployee()`呼び出し
  - UNIQUE制約違反のエラーハンドリング
  - キャッシュ再検証
  - 成功時は`{ success: true }`を返却（リダイレクトなし）
  - テストケース: 正常更新、権限エラー、バリデーションエラー、UNIQUE制約違反
  - _Requirements: 1.2, 1.5, 3.1, 3.4, 3.5, 3.6, 3.7, 6.2, 8.3_

- [ ] 3.4 社員削除Server Actionを実装
  - `deleteEmployeeAction(employeeId)`: 社員IDを受け取り
  - 権限チェック実行（エラー時は`throw`でerror.tsxへ）
  - `deleteEmployee()`呼び出し
  - キャッシュ再検証（`revalidatePath("/employees")`）
  - 成功時に社員一覧画面へリダイレクト（`redirect("/employees")`）
  - テストケース: 正常削除とリダイレクト、権限エラー、存在しない社員ID
  - _Requirements: 1.2, 1.5, 4.1, 4.5, 4.7, 4.8_

---

### 4. UIコンポーネント実装（shadcn/ui統合）

- [ ] 4.1 shadcn/ui DialogとAlertDialogをインストール
  - `npx shadcn@latest add dialog`
  - `npx shadcn@latest add alert-dialog`
  - インストール確認（`components/ui/dialog.tsx`, `components/ui/alert-dialog.tsx`の生成確認）
  - _Requirements: 4.1, 4.2_

- [ ] 4.2 削除確認ダイアログコンポーネントを実装
  - `DeleteEmployeeDialog`: AlertDialogコンポーネントを使用
  - Props: `employeeId`, `employeeName`, `employeeNumber`
  - ダイアログ内に社員名と社員番号を表示
  - 「削除を確定する」ボタンで`deleteEmployeeAction`を呼び出し
  - `useActionState`でローディング状態管理（`isPending`）
  - 「キャンセル」ボタンでダイアログを閉じる
  - テストケース: ダイアログ開閉、削除確定ボタンクリック、キャンセルボタンクリック、ローディング状態表示
  - _Requirements: 4.1, 4.2, 4.3, 4.4, 4.5_

- [ ] 4.3 共通フォームコンポーネントを実装（新規追加・編集共用）
  - `EmployeeForm`: 新規追加・編集モードを切り替え可能
  - Props: `mode`（"create" | "edit"）、`initialData`（編集時のみ）、`employeeId`（編集時のみ）
  - `useActionState`で`createEmployeeAction`または`updateEmployeeAction`を呼び出し
  - フォームフィールド: 社員番号、氏名（漢字・カナ）、メール、入社日、携帯電話
  - 社員番号フィールドは編集モード時は`disabled`
  - 必須フィールドにアスタリスク（*）表示
  - フィールドごとのエラーメッセージ表示（`state.fieldErrors`）
  - 全体エラーメッセージ表示（`state.errors`）
  - ローディング状態表示（「保存中...」）
  - キャンセルボタン: `useRouter()`の`router.push()`で表示モードに戻る
  - テストケース: 新規追加モード表示、編集モード表示、社員番号disabled、必須フィールドアスタリスク、エラーメッセージ表示、ローディング状態、キャンセルボタン
  - _Requirements: 2.2, 2.9, 3.2, 3.8, 5.1, 5.2, 5.3, 5.4, 5.5, 5.6_

---

### 5. ページ統合

- [ ] 5.1 新規社員追加ページを実装
  - `/app/employees/new/page.tsx`: Server Componentとして実装
  - `getUser()`で認証チェック（未認証は`/login`へリダイレクト）
  - `getProfileByUserId()`で権限チェック（一般ユーザーは403エラー）
  - `EmployeeForm`コンポーネントを`mode="create"`で表示
  - メタデータ生成（`title: "新規社員追加 - peer-search"`）
  - テストケース: 管理者アクセス時のフォーム表示、一般ユーザーアクセス時の403エラー
  - _Requirements: 1.3, 1.4, 1.5, 2.1, 7.3_

- [ ] 5.2 社員詳細ページに編集・削除機能を統合
  - `/app/employees/[employeeId]/page.tsx`: 既存ページを拡張
  - クエリパラメータ`?mode=edit`で編集モードに切り替え
  - 編集モード時: `EmployeeForm`コンポーネントを`mode="edit"`、`initialData={employee}`で表示
  - 表示モード時: 管理者のみ「編集」ボタンと`DeleteEmployeeDialog`を表示
  - 編集モードは管理者のみアクセス可能（一般ユーザーは403エラー）
  - メタデータ生成（`title: "{氏名} - 社員詳細 - peer-search"`）
  - テストケース: 表示モード表示、編集ボタン表示（管理者のみ）、削除ボタン表示（管理者のみ）、編集モード表示、一般ユーザーの編集モードアクセス拒否
  - _Requirements: 1.2, 1.3, 1.4, 1.5, 3.1, 4.1, 7.1, 7.3, 7.5_

- [ ] 5.3 PageHeaderに「新規社員追加」リンクを追加
  - `/components/layout/page-header.tsx`: 既存コンポーネントを拡張
  - `isAdmin`プロパティが`true`の場合のみリンク表示
  - リンク先: `/employees/new`
  - テストケース: 管理者時のリンク表示、一般ユーザー時のリンク非表示
  - _Requirements: 1.4, 7.4_

---

### 6. エラーハンドリングとナビゲーション

- [ ] 6.1 403エラーページのカスタマイズ
  - `/app/employees/error.tsx`: 既存エラーページを確認・拡張
  - `error.message === "Forbidden"`時に403専用メッセージ表示
  - 「この操作を実行する権限がありません」メッセージ
  - 社員一覧へ戻るリンク表示
  - テストケース: 403エラー発生時のメッセージ表示、リンク動作確認
  - _Requirements: 1.5, 8.2_

- [ ] 6.2 キャッシュ再検証とリダイレクトの動作確認
  - 新規追加後のリダイレクト先（社員詳細画面）を確認
  - 削除後のリダイレクト先（社員一覧）を確認
  - キャッシュ再検証による最新データ表示を確認
  - ブラウザの戻るボタンで前のページに戻れることを確認
  - テストケース: 新規追加後のリダイレクト、削除後のリダイレクト、キャッシュ再検証、ブラウザ戻るボタン
  - _Requirements: 2.7, 4.7, 7.1, 7.2_

---

### 7. 統合テストとエンドツーエンドテスト

- [ ] 7.1 新規社員追加フローの統合テスト
  - 管理者ログイン → 新規追加ページアクセス → フォーム入力 → 保存 → 詳細画面表示
  - バリデーションエラー時のエラーメッセージ表示確認
  - UNIQUE制約違反時のエラーメッセージ表示確認
  - テストケース: 正常フロー、バリデーションエラー、UNIQUE制約違反
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5, 2.6, 2.7, 2.8_

- [ ] 7.2 社員情報編集フローの統合テスト
  - 管理者ログイン → 社員詳細画面 → 編集ボタンクリック → フォーム編集 → 保存 → 表示モード表示
  - 社員番号が読み取り専用であることを確認
  - バリデーションエラー時のエラーメッセージ表示確認
  - キャンセルボタンで表示モードに戻ることを確認
  - テストケース: 正常フロー、社員番号disabled、バリデーションエラー、キャンセル操作
  - _Requirements: 3.1, 3.2, 3.3, 3.4, 3.5, 3.6, 3.7, 3.8_

- [ ] 7.3 社員削除フローの統合テスト
  - 管理者ログイン → 社員詳細画面 → 削除ボタンクリック → 確認ダイアログ表示 → 削除確定 → 一覧画面表示
  - 削除確認ダイアログに社員名・社員番号が表示されることを確認
  - キャンセルボタンで削除がキャンセルされることを確認
  - `employee_organizations`がCASCADE DELETEされることを確認
  - テストケース: 正常フロー、削除確認ダイアログ表示、キャンセル操作、CASCADE DELETE動作
  - _Requirements: 4.1, 4.2, 4.3, 4.4, 4.5, 4.6, 4.7_

- [ ] 7.4 権限チェックの統合テスト
  - 一般ユーザーログイン → 新規追加ページアクセス → 403エラー
  - 一般ユーザーログイン → 社員詳細画面 → 編集・削除ボタン非表示
  - 一般ユーザーログイン → 直接URLで編集モードアクセス → 403エラー
  - 管理者ログイン → PageHeaderに「新規社員追加」リンク表示
  - テストケース: 一般ユーザーの新規追加ページアクセス拒否、編集・削除ボタン非表示、直接URL編集モードアクセス拒否、管理者のリンク表示
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5, 1.6_

- [ ] 7.5 パフォーマンスとSEOの検証
  - Server Componentsでのサーバーサイドレンダリング確認
  - Server Actionsによるフォーム送信確認
  - ページメタデータ生成確認（title）
  - Drizzle ORMプリペアドステートメントの使用確認
  - テストケース: SSR動作、Server Actions動作、メタデータ生成、SQLインジェクション防止
  - _Requirements: 9.1, 9.2, 9.3, 9.4, 9.5_

---

### 8. コード品質とテストカバレッジ

- [ ]* 8.1 Validation Layerのテストカバレッジを100%にする
  - `validateEmployeeData()`の全パターンテスト
  - 境界値テスト（文字数制限、日付範囲）
  - 組み合わせテスト（複数フィールドエラー）
  - _Requirements: 10.2, 10.5, 10.6_

- [ ]* 8.2 Service Layerのテストカバレッジを90%以上にする
  - `createEmployee()`, `updateEmployee()`, `deleteEmployee()`の全パターンテスト
  - エラーケースの網羅
  - _Requirements: 10.4, 10.5, 10.6_

- [ ]* 8.3 Server Actionsのテストカバレッジを85%以上にする
  - 権限チェック、バリデーション、CRUD操作の全パターンテスト
  - エラーハンドリングの網羅
  - _Requirements: 10.1, 10.3, 10.5, 10.6_

- [ ]* 8.4 コンポーネントのテストカバレッジを80%以上にする
  - `EmployeeForm`, `DeleteEmployeeDialog`のレンダリングテスト
  - ユーザーインタラクションテスト
  - _Requirements: 10.1, 10.5, 10.6_

- [ ] 8.5 TypeScript strictモード準拠とBiomeリントチェック
  - 全ファイルでTypeScript strictモード準拠確認
  - `any`使用箇所の排除
  - Biomeによるリント・フォーマットチェック通過
  - テストケース: `pnpm lint`、`pnpm format`の実行確認
  - _Requirements: 10.5, 10.6_

---

## 要件カバレッジマトリクス

| 要件 | タスク |
|------|--------|
| 1.1 管理者権限チェック（ロール取得） | 3.1 |
| 1.2 管理者権限チェック（条件付きUI表示） | 3.2, 3.3, 3.4, 5.2, 7.4 |
| 1.3 管理者権限チェック（サーバーサイド検証） | 5.1, 5.2, 7.4 |
| 1.4 管理者権限チェック（新規社員追加リンク表示） | 5.1, 5.2, 5.3, 7.4 |
| 1.5 管理者権限チェック（403エラー） | 3.2, 3.3, 3.4, 5.1, 5.2, 6.1, 7.4 |
| 1.6 管理者権限チェック（`getProfileByUserId()`使用） | 3.1, 7.4 |
| 2.1 新規社員追加（ページ遷移） | 3.2, 5.1, 7.1 |
| 2.2 新規社員追加（空フォーム表示） | 1.1, 4.3, 7.1 |
| 2.3 新規社員追加（バリデーション適用） | 1.2, 3.2, 7.1 |
| 2.4 新規社員追加（送信ボタン無効化） | 3.2, 7.1 |
| 2.5 新規社員追加（エラーメッセージ表示） | 1.2, 3.2, 7.1 |
| 2.6 新規社員追加（データベース挿入） | 2.1, 3.2, 6.1, 7.1 |
| 2.7 新規社員追加（リダイレクト） | 3.2, 6.2, 7.1 |
| 2.8 新規社員追加（エラーハンドリング） | 3.2, 7.1 |
| 2.9 新規社員追加（キャンセルボタン） | 4.3 |
| 3.1 社員情報編集（編集モード切り替え） | 5.2, 7.2 |
| 3.2 社員情報編集（既存データ初期値設定） | 4.3, 7.2 |
| 3.3 社員情報編集（社員番号読み取り専用） | 7.2 |
| 3.4 社員情報編集（バリデーション適用） | 3.3, 7.2 |
| 3.5 社員情報編集（データベース更新） | 2.2, 3.3, 7.2 |
| 3.6 社員情報編集（表示モード表示） | 3.3, 7.2 |
| 3.7 社員情報編集（エラーハンドリング） | 2.2, 3.3, 7.2 |
| 3.8 社員情報編集（キャンセルボタン） | 4.3, 7.2 |
| 4.1 社員削除（削除ボタンクリック） | 4.1, 4.2, 5.2, 7.3 |
| 4.2 社員削除（確認ダイアログ表示） | 4.1, 4.2, 7.3 |
| 4.3 社員削除（ボタン提供） | 4.2, 7.3 |
| 4.4 社員削除（キャンセル操作） | 4.2, 7.3 |
| 4.5 社員削除（データベース削除） | 2.3, 3.4, 4.2, 7.3 |
| 4.6 社員削除（CASCADE DELETE） | 2.3, 7.3 |
| 4.7 社員削除（リダイレクト） | 3.4, 6.2, 7.3 |
| 4.8 社員削除（エラーハンドリング） | 3.4 |
| 5.1 フォームUI（統一デザイン） | 4.3 |
| 5.2 フォームUI（必須フィールド表示） | 4.3 |
| 5.3 フォームUI（エラーメッセージ表示） | 4.3 |
| 5.4 フォームUI（日付ピッカー） | 4.3 |
| 5.5 フォームUI（ローディング表示） | 4.3 |
| 5.6 フォームUI（モバイル対応） | 4.3 |
| 6.1 データ永続化（社員番号一意性） | 1.1, 3.2 |
| 6.2 データ永続化（メールアドレス一意性） | 1.1, 2.2, 3.2, 3.3 |
| 6.3 データ永続化（メール形式検証） | 1.2 |
| 6.4 データ永続化（入社日検証） | 1.2 |
| 6.5 データ永続化（氏名検証） | 1.2 |
| 6.6 データ永続化（トランザクション） | 2.1 |
| 7.1 ナビゲーション（リダイレクト） | 5.2, 6.2 |
| 7.2 ナビゲーション（ブラウザ戻るボタン） | 6.2 |
| 7.3 ナビゲーション（メタデータ生成） | 5.1, 5.2 |
| 7.4 ナビゲーション（新規社員追加リンク） | 5.3 |
| 7.5 ナビゲーション（編集モード切り替え） | 5.2 |
| 8.2 エラーハンドリング（権限不足） | 6.1 |
| 8.3 エラーハンドリング（制約違反） | 3.2, 3.3 |
| 9.1 パフォーマンス（RSC） | 7.5 |
| 9.2 パフォーマンス（Server Actions） | 7.5 |
| 9.3 パフォーマンス（SQLインジェクション防止） | 7.5 |
| 9.4 パフォーマンス（メタデータ生成） | 7.5 |
| 9.5 パフォーマンス（サーバーサイド中心） | 7.5 |
| 10.1 テスト（コンポーネントテスト） | 8.3, 8.4 |
| 10.2 テスト（バリデーションテスト） | 8.1 |
| 10.3 テスト（権限チェックテスト） | 8.3 |
| 10.4 テスト（データベース操作テスト） | 8.2 |
| 10.5 テスト（TypeScript strictモード） | 8.1, 8.2, 8.3, 8.4, 8.5 |
| 10.6 テスト（Biomeリント） | 8.1, 8.2, 8.3, 8.4, 8.5 |

---

## 実装順序の推奨

1. **タスク1（型定義・バリデーション）**: 並行実行可能（1.1, 1.2）
2. **タスク2（データレイヤー）**: 並行実行可能（2.1, 2.2, 2.3）
3. **タスク3（Server Actions）**: 3.1実装後、3.2～3.4を並行実行可能
4. **タスク4（UIコンポーネント）**: 4.1実装後、4.2と4.3を並行実行可能
5. **タスク5（ページ統合）**: 5.1と5.3は並行実行可能、5.2は5.1後に実装
6. **タスク6（エラーハンドリング）**: 6.1と6.2を順次実装
7. **タスク7（統合テスト）**: 7.1～7.5を順次実装
8. **タスク8（コード品質）**: 8.1～8.4は並行実行可能、8.5は最後に実装

---

## 注意事項

- **テストファースト**: 各タスクでテストケースを先に実装し、その後に本実装を行う
- **統合テストの重要性**: タスク7の統合テストで全体の動作を確認し、バグを早期に発見する
- **TypeScript strict mode**: 全タスクで型安全性を保証し、`any`の使用を避ける
- **Biome準拠**: 全タスクでBiomeのリント・フォーマットルールに準拠する
- **並行実行**: `(P)`マークの付いたタスクは並行実行可能だが、依存関係を考慮すること
- **オプションタスク**: `*`マークの付いたタスクはMVP後に実装可能（テストカバレッジ向上）

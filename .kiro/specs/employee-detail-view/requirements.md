# 要件定義書: 社員詳細画面

## 導入

### 概要
社員詳細画面（`/employees/[employeeId]`）は、特定の社員の詳細情報を表示する画面です。左側に3:4比率の写真表示エリア、右側に社員情報カードを配置する2カラムレイアウトにより、視覚的に整理された情報閲覧体験を提供します。

### 目的
- 社員一覧画面からのシームレスな遷移により、詳細情報の確認を実現する
- S3から取得した社員写真を適切なアスペクト比で表示する
- 複数所属を持つ社員の全所属情報を明確に表示する
- 連絡先情報（携帯・メール）を確認可能にする

### スコープ
- **対象機能**: 動的ルーティング、社員情報表示、S3写真表示、所属一覧表示
- **対象外**: 社員情報の編集、写真アップロード、印刷機能、共有機能

### ユーザーストーリー
- **社員として**: 同僚の詳細情報を確認し、連絡を取りたい
- **管理者として**: 特定社員の所属情報を詳細に確認したい
- **人事担当として**: 社員番号や入社年などの基本情報を参照したい

---

## 要件

### 要件1: 動的ルーティングとデータフェッチ

**目的**: ユーザーとして、URLパラメータで指定された社員の詳細情報を表示する

#### 受入基準
1. When ユーザーが`/employees/[employeeId]`にアクセスした場合、The 社員詳細画面 shall 指定されたemployeeIdに一致する社員データをデータベースから取得する
2. When 指定されたemployeeIdが存在しない場合、The 社員詳細画面 shall 404エラーページを表示する
3. While データ取得中、The 社員詳細画面 shall ローディングインジケーター（loading.tsx）を表示する
4. If データ取得時にエラーが発生した場合、The 社員詳細画面 shall エラーページ（error.tsx）を表示する
5. The 社員詳細画面 shall React Server Components（RSC）を使用してサーバーサイドでデータをフェッチする
6. The 社員詳細画面 shall Drizzle ORMを使用してタイプセーフにデータベースからデータを取得する
7. The 社員詳細画面 shall 社員の基本情報と所属組織情報をJOINクエリで一度に取得する

---

### 要件2: 2カラムレイアウト

**目的**: ユーザーとして、写真と情報を視覚的に分離して閲覧できるようにする

#### 受入基準
1. The 社員詳細画面 shall デスクトップ表示時に左右2カラムのレイアウトを採用する
2. The 左カラム shall 社員写真表示エリアとする
3. The 右カラム shall 社員情報カードとする
4. When モバイル・タブレット表示時、The 社員詳細画面 shall 縦方向の1カラムレイアウトに切り替える（写真が上、情報が下）
5. The レイアウト shall Tailwind CSS GridまたはFlexboxを使用して実装する
6. The レイアウト shall レスポンシブブレークポイント（md, lg）で適切に調整される

---

### 要件3: 社員写真表示機能

**目的**: ユーザーとして、社員の写真を正しいアスペクト比で視認性高く表示する

#### 受入基準
1. The 社員写真表示エリア shall 3:4のアスペクト比（縦長）を維持する
2. When 社員の写真が存在する場合、The 社員詳細画面 shall S3からPresigned URLを取得して写真を表示する
3. When 社員の写真が存在しない場合、The 社員詳細画面 shall デフォルトのプレースホルダー画像を表示する
4. The 社員写真 shall `object-fit: contain`を使用してアスペクト比を保持したまま表示する
5. The 社員写真 shall 表示エリアの中央に配置される
6. The 社員写真 shall 枠外にはみ出さないように制約される
7. The 社員写真の余白 shall 白色（`bg-white`）で表示される
8. The 社員詳細画面 shall Next.js Imageコンポーネントを使用して写真を最適化表示する
9. The 社員詳細画面 shall S3クライアント（`lib/s3/presigned-url.ts`）を使用してPresigned URLを生成する
10. The Presigned URL shall セキュリティのため有効期限（デフォルト1時間）を持つ

---

### 要件4: 社員情報カード表示機能

**目的**: ユーザーとして、社員の基本情報と所属情報を明確に確認できるようにする

#### 受入基準
1. The 社員情報カード shall shadcn/ui Cardコンポーネントを使用して実装する
2. The 社員情報カード shall 以下の情報を表示する:
   - 氏名（漢字） - 見出しとして強調表示
   - フリガナ - 氏名の下に小さめのフォントで表示
   - 社員番号
   - 入社年（hire_dateから年のみ抽出）
   - 携帯電話番号
   - メールアドレス
   - 所属一覧（複数行）
3. When 携帯電話番号が存在する場合、The 社員情報カード shall 電話番号を表示する
4. When 携帯電話番号が存在しない場合、The 社員情報カード shall "未登録"または"-"を表示する
5. The メールアドレス shall クリック可能なリンク（`mailto:`）として表示する
6. The 社員情報カード shall 各情報項目をラベル付きで表示する（例: "社員番号: 12345"）
7. The 社員情報カード shall 視覚的な階層構造（見出し、ラベル、値）を持つ

---

### 要件5: 所属一覧表示機能

**目的**: ユーザーとして、社員が所属する全ての組織と役職を確認できるようにする

#### 受入基準
1. When 社員が複数の組織に所属している場合、The 社員詳細画面 shall 全ての所属情報を複数行で表示する
2. The 所属情報 shall 以下のフォーマットで表示する: "会社名 本部名 部署名 課/チーム名（役職）"
3. When 社員が役職を持つ場合、The 所属情報 shall 役職を括弧付きで組織名の後に表示する
4. When 社員が役職を持たない場合、The 所属情報 shall 括弧なしで組織名のみを表示する
5. The 所属情報 shall 組織階層に基づいて適切な順序で表示される（level順）
6. When 社員が所属情報を持たない場合、The 社員詳細画面 shall "所属情報なし"メッセージを表示する
7. The 所属一覧 shall 各行を視覚的に区切って表示する（箇条書きまたは改行）

---

### 要件6: ナビゲーション機能

**目的**: ユーザーとして、社員一覧画面と詳細画面の間をスムーズに行き来できるようにする

#### 受入基準
1. The 社員詳細画面 shall 共通ヘッダー（PageHeader）を表示する
2. When ユーザーがヘッダーのロゴをクリックした場合、The 社員詳細画面 shall ホームページ（`/`）にリダイレクトする
3. When ユーザーがヘッダーの検索バーを使用した場合、The 社員詳細画面 shall 社員一覧画面（`/employees`）に検索パラメータ付きで遷移する
4. The 社員詳細画面 shall ブラウザの戻るボタンで社員一覧画面に戻れるようにする
5. The 社員詳細画面 shall 現在のURLパスをブラウザの履歴に保存する

---

### 要件7: 認証とアクセス制御

**目的**: システムとして、認証済みユーザーのみが社員詳細画面にアクセスできるようにする

#### 受入基準
1. When 未認証ユーザーが`/employees/[employeeId]`にアクセスした場合、The proxy.ts shall ログイン画面（`/login`）にリダイレクトする
2. The 社員詳細画面 shall `getUser()`関数を使用してサーバーサイドで認証状態を確認する
3. The 社員詳細画面 shall Supabase SSR認証を使用してセッション管理を行う
4. When 認証情報が無効な場合、The 社員詳細画面 shall ログイン画面にリダイレクトする

---

### 要件8: パフォーマンスとSEO

**目的**: システムとして、高速なページ表示と適切なSEO対応を実現する

#### 受入基準
1. The 社員詳細画面 shall React Server Componentsを使用してサーバーサイドレンダリングを行う
2. The 社員詳細画面 shall Next.js Dynamic Routingの`generateMetadata`関数を使用してページタイトルを動的生成する
3. The ページタイトル shall "社員名 - 社員詳細 - peer-search"のフォーマットとする
4. The 社員詳細画面 shall Next.js Imageコンポーネントを使用して画像を最適化する
5. The 社員詳細画面 shall 初回表示時のデータフェッチをサーバーサイドで完了させる（クライアントサイドフェッチなし）
6. The 社員詳細画面 shall Presigned URLの生成をサーバーサイドで行い、クライアントに完成したURLを渡す

---

### 要件9: エラーハンドリング

**目的**: ユーザーとして、エラー発生時に適切なフィードバックを受け取る

#### 受入基準
1. When データベース接続エラーが発生した場合、The 社員詳細画面 shall エラーページを表示する
2. When S3画像取得エラーが発生した場合、The 社員詳細画面 shall プレースホルダー画像を表示し、エラーメッセージをコンソールに出力する
3. When 不正なemployeeId（UUID形式でない）が指定された場合、The 社員詳細画面 shall 404エラーページを表示する
4. If Presigned URL生成に失敗した場合、The 社員詳細画面 shall プレースホルダー画像を表示する
5. The エラーページ shall ホームに戻るリンクを含む
6. The エラーページ shall エラー内容を開発環境ではスタックトレース付きで表示する

---

### 要件10: レスポンシブデザイン

**目的**: ユーザーとして、デスクトップ・タブレット・モバイルで適切なレイアウトで情報を閲覧できるようにする

#### 受入基準
1. When デスクトップ表示時（md以上）、The 社員詳細画面 shall 左右2カラムレイアウトを表示する
2. When タブレット・モバイル表示時（md未満）、The 社員詳細画面 shall 縦方向1カラムレイアウトを表示する
3. The 写真表示エリア shall モバイル表示時に適切なサイズに調整される
4. The 社員情報カード shall モバイル表示時に横幅100%で表示される
5. The 社員詳細画面 shall Tailwind CSSのブレークポイント（sm, md, lg）を使用してレスポンシブ対応する
6. The 社員詳細画面 shall 全てのビューポートサイズで読みやすいフォントサイズと行間を保つ

---

## 補足情報

### プロジェクト概要（入力情報）
3.3 社員詳細画面（/employees/[employeeId]）
3.3.1 レイアウト
左：写真表示枠（3:4）
右：社員情報カード
3.3.2 写真表示（S3画像）
object-fit: contain
中央配置
枠外にはみ出し禁止
アスペクト比の歪み禁止
余白は常に白
3.3.3 情報表示
氏名（漢字／フリガナ）
社員番号
入社年
携帯
メール
所属一覧（複数行）

### 技術的制約
- Next.js 16 App Routerの動的ルーティング規約に従う
- React 19 Server Componentsをデフォルトとする
- TypeScript strictモードを使用する
- Drizzle ORMでタイプセーフなクエリを実装する
- AWS S3 Presigned URL方式で画像を取得する
- shadcn/uiコンポーネントを使用する
- Tailwind CSS 4でスタイリングする

### 依存機能
- 社員一覧画面（employee-list-view）: 詳細画面への遷移元
- 共通ヘッダー（page-header）: ナビゲーション提供
- S3 Presigned URL機能（static-files）: 画像取得
- Supabase認証（supabase-auth）: アクセス制御
- Drizzle ORM（employees, employee_organizations, organizations）: データ取得

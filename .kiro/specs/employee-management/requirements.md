# 要件定義書: 社員管理機能（追加・編集・削除）

## 導入

### 概要
社員管理機能は、管理者権限を持つユーザーが社員情報の追加・編集・削除を実行できる機能です。社員詳細画面から直接操作でき、新規社員追加はヘッダーからアクセス可能な専用ページ（`/employees/new`）で実行します。

### 目的
- 管理者が社員データのCRUD操作（Create/Update/Delete）を安全に実行できる
- 一般ユーザーからは操作UIを隠蔽し、権限管理を徹底する
- 新規追加・編集時にはバリデーション付きフォームで入力品質を確保する
- 削除時には確認ダイアログで誤操作を防止する

### スコープ
- **対象機能**: 新規社員追加、社員情報編集、社員削除、管理者権限チェック
- **対象外**: 一括インポート、写真編集、履歴管理、削除社員の復元

### ユーザーストーリー
- **管理者として**: 新規入社社員の情報を登録し、検索可能にしたい
- **管理者として**: 既存社員の連絡先や所属を更新し、最新状態を維持したい
- **管理者として**: 退職社員を削除し、データベースを整理したい
- **一般ユーザーとして**: 閲覧のみで編集操作を誤って実行しないようにしたい

---

## 要件

### 要件1: 管理者権限チェック

**目的**: 管理者として、社員管理機能へのアクセスを権限に基づいて制御する

#### 受入基準
1. The 社員管理システム shall ユーザーのプロフィール情報から`role`フィールドを取得し、権限を判定する
2. When ユーザーのroleが`admin`の場合、The 社員管理システム shall 社員詳細画面に「編集」ボタンと「削除」ボタンを表示する
3. When ユーザーのroleが`user`の場合、The 社員管理システム shall 「編集」ボタンと「削除」ボタンを非表示にする
4. The 社員管理システム shall ヘッダーメニューの「新規社員追加」リンクを管理者にのみ表示する
5. When 一般ユーザーが直接URL（`/employees/new`または編集ページ）にアクセスした場合、The 社員管理システム shall 403エラーページを表示する
6. The 社員管理システム shall `getProfileByUserId()`関数を使用してサーバーサイドで権限チェックを実行する

---

### 要件2: 新規社員追加（`/employees/new`）

**目的**: 管理者として、新規社員の情報を入力し、データベースに登録する

#### 受入基準
1. When 管理者がヘッダーの「新規社員追加」リンクをクリックした場合、The 社員管理システム shall `/employees/new`ページへ遷移する
2. The 新規社員追加ページ shall 空のフォームを表示する（社員番号、氏名（漢字・カナ）、メール、入社日は必須、携帯電話は任意）
3. The 新規社員追加フォーム shall 各フィールドに適切なバリデーションを適用する（社員番号の一意性、メールアドレス形式、入社日の有効性）
4. When 必須フィールドが未入力の場合、The 新規社員追加フォーム shall 送信ボタンを無効化し、エラーメッセージを表示する
5. When フォーム送信時にバリデーションエラーが発生した場合、The 新規社員追加フォーム shall フィールドごとにエラーメッセージを表示する
6. When 保存ボタンをクリックした場合、The 社員管理システム shall Drizzle ORMを使用してemployeesテーブルに新規レコードを挿入する
7. When 保存に成功した場合、The 社員管理システム shall 作成された社員の詳細画面（`/employees/[employeeId]`）へリダイレクトする
8. If データベースエラー（重複社員番号、重複メールアドレスなど）が発生した場合、The 新規社員追加フォーム shall エラーメッセージを表示し、フォーム状態を保持する
9. The 新規社員追加フォーム shall 「キャンセル」ボタンを提供し、クリック時に`/employees`へ戻る

---

### 要件3: 社員情報編集

**目的**: 管理者として、既存社員の情報を更新する

#### 受入基準
1. When 管理者が社員詳細画面の「編集」ボタンをクリックした場合、The 社員管理システム shall 同じページ内でフォームモードに切り替える
2. The 編集フォーム shall 既存の社員データを全フィールドに初期値として設定する
3. The 編集フォーム shall 社員番号フィールドを読み取り専用（disabled）にする（一意性を保つため変更不可）
4. The 編集フォーム shall 新規追加と同じバリデーションルールを適用する（メール形式、入社日有効性）
5. When 保存ボタンをクリックした場合、The 社員管理システム shall Drizzle ORMを使用してemployeesテーブルの該当レコードを更新する
6. When 更新に成功した場合、The 社員管理システム shall フォームモードを終了し、更新後の詳細情報を表示モードで表示する
7. If データベースエラー（メールアドレス重複など）が発生した場合、The 編集フォーム shall エラーメッセージを表示し、フォーム状態を保持する
8. The 編集フォーム shall 「キャンセル」ボタンを提供し、クリック時に表示モードに戻る（変更を破棄）

---

### 要件4: 社員削除

**目的**: 管理者として、不要な社員レコードを削除する

#### 受入基準
1. When 管理者が社員詳細画面の「削除」ボタンをクリックした場合、The 社員管理システム shall 確認ダイアログを表示する
2. The 削除確認ダイアログ shall 削除対象の社員名（漢字）と社員番号を表示する
3. The 削除確認ダイアログ shall 「削除を確定する」ボタンと「キャンセル」ボタンを提供する
4. When ユーザーが「キャンセル」をクリックした場合、The 社員管理システム shall ダイアログを閉じ、何も実行しない
5. When ユーザーが「削除を確定する」をクリックした場合、The 社員管理システム shall Drizzle ORMを使用してemployeesテーブルから該当レコードを削除する
6. The 社員管理システム shall 外部キー制約により`employee_organizations`テーブルの関連レコードをカスケード削除する（ON DELETE CASCADE）
7. When 削除に成功した場合、The 社員管理システム shall `/employees`ページへリダイレクトする
8. If 削除中にデータベースエラーが発生した場合、The 社員管理システム shall エラーメッセージをトースト通知で表示し、詳細画面を維持する

---

### 要件5: フォームUI

**目的**: 管理者として、使いやすく視覚的に明確なフォームで社員情報を入力する

#### 受入基準
1. The 社員管理フォーム shall shadcn/uiの`Input`、`Label`、`Button`コンポーネントを使用して統一されたデザインを実現する
2. The 社員管理フォーム shall 必須フィールドにアスタリスク（*）を表示する
3. The 社員管理フォーム shall フィールドごとにバリデーションエラーメッセージを赤色テキストで表示する
4. The 社員管理フォーム shall 入社日フィールドに日付ピッカー（`type="date"`）を使用する
5. The 社員管理フォーム shall フォーム送信中にローディングインジケーターを表示し、重複送信を防止する
6. The 社員管理フォーム shall モバイル表示時に各フィールドが縦方向に並び、タップ可能な十分なサイズを確保する

---

### 要件6: データ永続化とバリデーション

**目的**: 管理者として、データベースの整合性を保ちながら社員情報を管理する

#### 受入基準
1. The 社員管理システム shall 社員番号の一意性を保証し、重複時にはエラーメッセージ「この社員番号は既に使用されています」を表示する
2. The 社員管理システム shall メールアドレスの一意性を保証し、重複時にはエラーメッセージ「このメールアドレスは既に使用されています」を表示する
3. The 社員管理システム shall メールアドレスの形式を正規表現で検証し、不正な場合は「有効なメールアドレスを入力してください」を表示する
4. The 社員管理システム shall 入社日が未来の日付でないことを検証し、未来日の場合は「入社日は本日以前の日付を指定してください」を表示する
5. The 社員管理システム shall 氏名（漢字）と氏名（カナ）が空でないことを検証し、空の場合は「この項目は必須です」を表示する
6. The 社員管理システム shall Drizzle ORMのトランザクション機能を使用し、複数テーブルへの書き込みの原子性を保証する

---

### 要件7: ナビゲーションと統合

**目的**: 管理者として、社員管理操作をシームレスに実行し、既存機能と統合する

#### 受入基準
1. The 社員管理システム shall 新規追加・編集・削除の各操作後に適切なページへリダイレクトする（新規→詳細、編集→詳細、削除→一覧）
2. The 社員管理システム shall ブラウザの戻るボタンで前のページへ戻れるようにする
3. The 社員管理システム shall 各ページのメタデータ（title）を適切に設定する（例: 「新規社員追加 - peer-search」）
4. The PageHeader shall 管理者にのみヘッダーメニューに「新規社員追加」リンクを表示する
5. The 社員詳細画面 shall 編集モードと表示モードを同一URLで切り替え可能にする（クエリパラメータ`?mode=edit`を使用）

---

### 要件8: エラーハンドリング

**目的**: 管理者として、エラー発生時に適切なフィードバックを受け取る

#### 受入基準
1. If ネットワークエラーが発生した場合、The 社員管理システム shall エラーページ（error.tsx）を表示し、再試行ボタンを提供する
2. If 権限不足（403）の場合、The 社員管理システム shall 「この操作を実行する権限がありません」メッセージを表示する
3. If データベース制約違反が発生した場合、The 社員管理システム shall 具体的なエラーメッセージをフォーム内に表示する
4. The 社員管理システム shall 開発環境（`NODE_ENV=development`）ではエラースタックトレースをコンソールに出力する
5. The 社員管理システム shall 本番環境ではユーザーフレンドリーなエラーメッセージのみを表示し、技術的詳細を隠蔽する

---

### 要件9: パフォーマンスとSEO

**目的**: 管理者として、高速かつ検索エンジンに適したページで社員管理を実行する

#### 受入基準
1. The 新規社員追加ページ shall React Server Components（RSC）を使用してサーバーサイドレンダリングを実行する
2. The 社員管理システム shall フォーム送信にServer Actionsを使用し、クライアントサイドJavaScriptを最小化する
3. The 社員管理システム shall Drizzle ORMのプリペアドステートメントを使用してSQLインジェクション攻撃を防止する
4. The 新規社員追加ページ shall 動的メタデータ（`generateMetadata()`）で適切なページタイトルを生成する
5. The 社員管理システム shall 不要なクライアントサイドステート管理を避け、サーバーサイド中心のアーキテクチャを維持する

---

### 要件10: テストとコード品質

**目的**: 開発者として、社員管理機能の品質を自動テストで保証する

#### 受入基準
1. The 社員管理機能 shall 各フォームコンポーネントにユニットテストを実装する（Vitest + React Testing Library）
2. The 社員管理機能 shall バリデーションロジックに対するテストケースを実装する（成功パターン、エラーパターン）
3. The 社員管理機能 shall 権限チェック機能に対するテストケースを実装する（管理者/一般ユーザー）
4. The 社員管理機能 shall データベース操作（追加・更新・削除）に対するインテグレーションテストを実装する
5. The 社員管理機能 shall TypeScript strictモードに準拠し、型安全性を保証する
6. The 社員管理機能 shall Biomeによるリント・フォーマットチェックを通過する

---

## 補足事項

### 既存機能との関係
- 本要件は既存の社員詳細画面（`employee-detail-view`）に編集・削除機能を追加します
- 既存の`EmployeeDetailCard`コンポーネントは編集モード対応のため部分的に拡張されます
- 新規追加ページ（`/employees/new`）は新規実装です

### セキュリティ考慮事項
- 全ての操作はサーバーサイドで権限チェックを実行します（クライアント側の制御のみに依存しない）
- Drizzle ORMのプリペアドステートメントによりSQLインジェクションを防止します
- CSRF保護はNext.js 16のServer Actionsにより自動的に実装されます

### 今後の拡張可能性
- 写真アップロード機能（AWS S3への直接アップロード）
- 所属組織の編集（複数所属の追加・削除）
- 操作履歴の記録（監査ログ）
- 削除社員の論理削除対応（物理削除から論理削除への変更）

# Implementation Plan

## Overview
本実装計画では、社員一覧画面にドロップダウンリスト形式のソートUIを追加します。既存のボタン形式ソートコントロール（`SortControls`）と新しいドロップダウン形式（`SortDropdown`）を並行運用し、段階的に移行します。バックエンドの `searchEmployees` 関数は既にソート機能を実装しているため、フロントエンドコンポーネントの追加のみで完結します。

## Task Breakdown

### 1. ドロップダウンソートコンポーネントの実装

- [x] 1.1 (P) ドロップダウンリストによるソートフィールド選択機能を実装する
  - shadcn/ui `Select` コンポーネントを使用してソートフィールドドロップダウンを実装
  - 3つのソートフィールド（氏名かな、社員番号、入社年）を選択肢として表示
  - 現在のソートフィールド（`currentSort` prop）を選択状態として表示
  - ソートフィールドが未選択の場合、プレースホルダー（"並び順を選択"）を表示
  - アクセシビリティのため `aria-label="ソート項目を選択"` を設定
  - _Requirements: 1.1, 1.2, 1.3, 1.5, 1.6, 6.1, 6.2, 6.3, 6.6, 6.7_

- [x] 1.2 (P) 昇順・降順切り替えボタンを実装する
  - shadcn/ui `Button` コンポーネントを使用して昇順・降順ボタンを作成
  - 現在のソート順序（`currentOrder` prop）に応じてアイコンを表示（ArrowUp: 昇順、ArrowDown: 降順）
  - ソートフィールドが未選択の場合、ボタンを無効化（`disabled={!currentSort}`）
  - アクセシビリティのため `aria-sort` 属性を設定（"ascending" / "descending" / "none"）
  - ボタンラベルを明確に設定（例: "昇順", "降順"）
  - _Requirements: 2.1, 2.2, 2.4, 2.5, 2.6, 6.6_

- [x] 1.3 URL クエリパラメータを更新してページ遷移を実行する
  - `useRouter` および `useSearchParams` フックを使用してURL遷移を処理
  - ドロップダウンでソートフィールドを選択した際、`router.push("/employees?sort={field}&order=asc")` を実行
  - 昇順・降順ボタンをクリックした際、現在の `order` を反転（asc ↔ desc）してURL更新
  - 既存の検索条件（`name`, `employee_number`, `hire_year`, `org_id`）を維持したままソート条件を追加
  - _Requirements: 1.4, 2.3, 3.1, 3.2, 4.2, 4.3, 6.4_

- [x] 1.4 (P) レスポンシブデザインを適用する
  - Tailwind CSS レスポンシブユーティリティ（`sm:`, `md:`, `lg:`）を使用してスタイリング
  - スマートフォン画面幅（320px以上）で適切に表示されるレイアウト
  - モバイル環境でタップしやすい最小タップ領域（44x44px以上）を確保
  - タブレット/デスクトップ環境で検索フォームとバランスの取れた配置
  - _Requirements: 7.1, 7.2, 7.3, 7.4, 7.5_

### 2. ページコンポーネントへの統合

- [x] 2.1 社員一覧画面に新しいドロップダウンソートコンポーネントを追加する
  - `app/employees/page.tsx` に `SortDropdown` コンポーネントをインポート
  - URL パラメータ（`params.sort`, `params.order`）を `SortDropdown` の props として渡す
  - 既存の `SortControls` コンポーネントを維持し、両UIを並行表示
  - 両コンポーネントが同じURL状態（`sort`, `order`）を共有することを確認
  - _Requirements: 1.1, 2.1, 3.3, 4.1, 4.4, 8.1, 8.2, 8.3_

- [x] 2.2 URL パラメータからソート条件を読み取る機能を確認する
  - `app/employees/page.tsx` の `searchParams` から `sort` および `order` を取得
  - `SearchEmployeesParams` 型に変換して `searchEmployees` 関数に渡す
  - ページが `sort` および `order` クエリパラメータ付きでロードされた際、ソートされた社員リストが表示されることを確認
  - ブラウザの戻る/進むボタンでソート状態が復元されることを確認
  - _Requirements: 3.3, 3.4, 3.5, 5.1_

### 3. コンポーネントテストの実装

- [x] 3.1 (P) ドロップダウンソートコンポーネントのユニットテストを作成する
  - Vitest + React Testing Library を使用してコンポーネントテストを実装
  - 3つのソートフィールド（氏名かな、社員番号、入社年）が表示されることをテスト
  - 現在のソートフィールドが選択状態として表示されることをテスト
  - ソートフィールド選択時に `router.push` が正しい URL で呼ばれることをテスト
  - 昇順・降順ボタンクリック時に URL が正しく更新されることをテスト
  - _Requirements: 9.1, 9.2, 9.3_

- [x] 3.2 (P) アクセシビリティ属性の検証テストを作成する
  - `aria-label` 属性が適切に設定されていることをテスト（"ソート項目を選択"）
  - `aria-sort` 属性が現在の状態を反映していることをテスト（"ascending" / "descending" / "none"）
  - キーボード操作（Enter, Space, ↑, ↓, Esc）が正しく動作することをテスト
  - ソートフィールドが未選択の場合、昇順・降順ボタンが `disabled` 状態であることをテスト
  - _Requirements: 1.6, 2.4, 2.5, 6.5, 6.6, 9.5_

- [x] 3.3 (P) エラーハンドリングとエッジケースのテストを作成する
  - 無効な `sort` パラメータ（例: `invalid_field`）が渡された場合の動作をテスト
  - 無効な `order` パラメータ（例: `invalid`）が渡された場合の動作をテスト
  - 検索結果が0件の場合でもソートコントロールが表示され続けることをテスト
  - _Requirements: 4.4, 9.4, 10.1, 10.2_

### 4. 統合テストとE2Eテスト

- [x] 4.1 (P) 既存 `searchEmployees` サービス関数のソート動作を検証する
  - `sort: "name_kana", order: "asc"` で氏名かな昇順ソートされることをテスト
  - `sort: "employee_number", order: "desc"` で社員番号降順ソートされることをテスト
  - `sort: "hire_date", order: "asc"` で入社日昇順ソートされることをテスト
  - 検索条件（`name`, `employeeNumber`, `hireYear`, `orgId`）とソート条件の複合動作をテスト
  - _Requirements: 4.1, 5.2, 5.3, 5.4, 9.3_

- [x]* 4.2 E2E テストでドロップダウンソート操作をシミュレートする（オプション）
  - Playwright MCP を使用して社員一覧画面にアクセス
  - ドロップダウンを開き、「氏名（かな）」を選択して社員リストがソートされることを確認
  - 昇順・降順ボタンをクリックしてソート順が反転することを確認
  - ブラウザの戻るボタンで以前のソート状態が復元されることを確認
  - _Requirements: 1.4, 2.3, 3.4_
  - _Note: E2Eテスト実装ガイド（e2e-test-guide.md）を作成。認証の制約により自動化E2Eテストは認証バイパス機能実装後に推奨。受け入れ基準はユニットテスト・統合テストで十分にカバー済み。_

### 5. 段階的移行の準備

- [x] 5.1 両ソートUIの共存状態を検証する
  - `SortDropdown` と `SortControls` が両方表示されることを確認
  - 両コンポーネントが同じ `currentSort` と `currentOrder` を受け取ることを確認
  - どちらからソート操作を行っても、もう一方のUIに変更が反映されることを確認
  - レイアウトが視覚的に混乱しないことを確認（両UIが明確に区別可能）
  - _Requirements: 8.1, 8.2, 8.3, 8.5_

- [x]* 5.2 ユーザーフィードバック収集のためのメトリクス計画を策定する（オプション）
  - ドロップダウン形式とボタン形式の使用率を測定する方法を計画（例: アナリティクストラッキング）
  - ユーザーアンケートまたは使用率分析の実施方法を検討
  - 最終的にどちらのUIを採用するかの判断基準を定義
  - _Requirements: 8.4_
  - _Note: メトリクス計画ドキュメント（metrics-plan.md）を作成。3つのアプローチ（アナリティクス、アンケート、A/Bテスト）と判断基準を定義。_

## Requirements Coverage Summary

全ての要件がタスクにマッピングされています：

- **Requirement 1 (ドロップダウンリストによるソートフィールド選択)**: 1.1, 2.1, 3.1, 3.2, 4.2
- **Requirement 2 (ソート順序の切り替え)**: 1.2, 2.1, 3.1, 3.2, 4.2
- **Requirement 3 (URL同期とブラウザ履歴対応)**: 1.3, 2.1, 2.2, 4.2
- **Requirement 4 (既存検索条件との統合)**: 1.3, 2.1, 2.2, 3.3, 4.1
- **Requirement 5 (サーバーサイドソート処理)**: 2.2, 4.1
- **Requirement 6 (UIコンポーネント設計とアクセシビリティ)**: 1.1, 1.2, 1.3, 3.2
- **Requirement 7 (レスポンシブデザイン対応)**: 1.4
- **Requirement 8 (既存UIとの共存と段階的移行)**: 2.1, 5.1, 5.2
- **Requirement 9 (テストカバレッジとバリデーション)**: 3.1, 3.2, 3.3, 4.1
- **Requirement 10 (エラーハンドリングと入力バリデーション)**: 3.3

## Implementation Notes

### 並行実行可能なタスク
以下のタスクは独立しており、並行して実装可能です（`(P)` マーク付き）：
- **Task 1.1, 1.2, 1.4**: コンポーネント実装の各サブタスクは、ファイル競合なく並行実行可能
- **Task 3.1, 3.2, 3.3**: テストファイルは独立しており、並行作成可能
- **Task 4.1**: 既存サービス関数のテストは、コンポーネント実装と並行実行可能

### 依存関係
以下のタスクは順次実行が必要です：
- **Task 1.3**: 1.1 と 1.2 の完了後に実装（ドロップダウンとボタンのUI実装が必要）
- **Task 2.1**: 1.1, 1.2, 1.3, 1.4 の完了後に統合（全コンポーネント機能の実装が前提）
- **Task 2.2**: 既存実装の確認のみ（新規実装不要）
- **Task 5.1**: 2.1 の完了後に検証（両UIの統合後に共存状態を検証）

### オプションタスク
以下のタスクは MVP 後に実施可能です（`- [ ]*` マーク付き）：
- **Task 4.2**: E2E テスト（受け入れ基準は既にユニットテストと統合テストでカバー済み）
- **Task 5.2**: ユーザーフィードバック収集計画（ビジネスレベルの計画）
